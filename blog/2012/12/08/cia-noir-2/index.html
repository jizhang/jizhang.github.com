<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Clojure实战(2)：使用Noir框架开发博客(中) | Ji ZHANG&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在Eclipse中编写Clojure代码从这章起我们就要开始真正的编码了。Vim可能是很多程序员的选择，但如果你像我一样更喜欢GUI界面，那就来看看如何在Eclipse中编写Clojure代码吧。
安装Eclipse插件Eclipse提供了一个Clojure插件：CounterClockwise，可以用来编写Clojure代码，进行语法高亮、调试等操作。打开Eclipse的Market Place">
<meta property="og:type" content="article">
<meta property="og:title" content="Clojure实战(2)：使用Noir框架开发博客(中)">
<meta property="og:url" content="http://shzhangji.com/blog/2012/12/08/cia-noir-2/index.html">
<meta property="og:site_name" content="Ji ZHANG's Blog">
<meta property="og:description" content="在Eclipse中编写Clojure代码从这章起我们就要开始真正的编码了。Vim可能是很多程序员的选择，但如果你像我一样更喜欢GUI界面，那就来看看如何在Eclipse中编写Clojure代码吧。
安装Eclipse插件Eclipse提供了一个Clojure插件：CounterClockwise，可以用来编写Clojure代码，进行语法高亮、调试等操作。打开Eclipse的Market Place">
<meta property="og:updated_time" content="2016-12-04T10:25:33.925Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Clojure实战(2)：使用Noir框架开发博客(中)">
<meta name="twitter:description" content="在Eclipse中编写Clojure代码从这章起我们就要开始真正的编码了。Vim可能是很多程序员的选择，但如果你像我一样更喜欢GUI界面，那就来看看如何在Eclipse中编写Clojure代码吧。
安装Eclipse插件Eclipse提供了一个Clojure插件：CounterClockwise，可以用来编写Clojure代码，进行语法高亮、调试等操作。打开Eclipse的Market Place">
<meta name="twitter:creator" content="@zjerryj">
<link rel="publisher" href="zhangji87@gmail.com">
  
    <link rel="alternate" href="/atom.xml" title="Ji ZHANG&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="https://fonts.proxy.ustclug.org/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37223379-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Ji ZHANG&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">If I rest, I rust.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/categories/Big-Data">Big Data</a>
        
          <a class="main-nav-link" href="/categories/Programming">Programming</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://shzhangji.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-cia-noir-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/12/08/cia-noir-2/" class="article-date">
  <time datetime="2012-12-08T12:09:00.000Z" itemprop="datePublished">2012-12-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tutorial/">Tutorial</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Clojure实战(2)：使用Noir框架开发博客(中)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="在Eclipse中编写Clojure代码"><a href="#在Eclipse中编写Clojure代码" class="headerlink" title="在Eclipse中编写Clojure代码"></a>在Eclipse中编写Clojure代码</h2><p>从这章起我们就要开始真正的编码了。Vim可能是很多程序员的选择，但如果你像我一样更喜欢GUI界面，那就来看看如何在Eclipse中编写Clojure代码吧。</p>
<h3 id="安装Eclipse插件"><a href="#安装Eclipse插件" class="headerlink" title="安装Eclipse插件"></a>安装Eclipse插件</h3><p>Eclipse提供了一个Clojure插件：CounterClockwise，可以用来编写Clojure代码，进行语法高亮、调试等操作。打开Eclipse的Market Place，搜索counterclockwise关键字，点击Install即可。</p>
<h3 id="将Leiningen项目导入Eclipse"><a href="#将Leiningen项目导入Eclipse" class="headerlink" title="将Leiningen项目导入Eclipse"></a>将Leiningen项目导入Eclipse</h3><p>由于CounterClockwise插件并没有默认使用Leiningen来管理项目，因此需要做一些额外的工作。</p>
<p>在使用<code>lein new</code>命令创建项目后，在project.clj文件中增加如下一行：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="name">defproject</span> ...</div><div class="line">            <span class="symbol">:dev-dependencies</span> [[lein-eclipse <span class="string">"1.0.0"</span>]]</div><div class="line">            ...)</div></pre></td></tr></table></figure>
<p>然后依次执行<code>lein deps</code>和<code>lein eclipse</code>，会看到项目根目录下生成了.project和.classpath文件。然后就可以进入Eclipse导入这个项目了。如果使用Git进行版本控制，<code>lein</code>已经为你生成好了.gitignore文件。执行了<code>git init</code>后，就能在Eclilpse中选择Share Project菜单项，进行可视化的版本控制。</p>
<h2 id="使用表单"><a href="#使用表单" class="headerlink" title="使用表单"></a>使用表单</h2><p>我们现在需要编写一个新建文章的功能，它是一个简单的页面，页面上有“标题”和“内容”两个文本框，并有一个“提交”按钮。</p>
<p>在src/blog/views目录下新建一个文件article.clj，输入以下内容：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">(<span class="name"><span class="builtin-name">ns</span></span> blog.views.article</div><div class="line">  (<span class="symbol">:require</span> [blog.views.common <span class="symbol">:as</span> common])</div><div class="line">  (<span class="symbol">:use</span> [noir.core]</div><div class="line">        [hiccup.form-helpers]))</div><div class="line"></div><div class="line">(<span class="name">defpage</span> <span class="string">"/blog/add"</span> []</div><div class="line">  (<span class="name">common/layout</span></div><div class="line">    [<span class="symbol">:h1</span> <span class="string">"新建文章"</span>]</div><div class="line">    (<span class="name">form-to</span> [<span class="symbol">:post</span> <span class="string">"/blog/add"</span>]</div><div class="line">             (<span class="name">label</span> <span class="string">"title"</span> <span class="string">"标题："</span>)</div><div class="line">             (<span class="name">text-field</span> &#123;<span class="symbol">:size</span> <span class="number">50</span>&#125; <span class="string">"title"</span>) [<span class="symbol">:br</span>]</div><div class="line">             (<span class="name">label</span> <span class="string">"content"</span> <span class="string">"内容："</span>)</div><div class="line">             (<span class="name">text-area</span> &#123;<span class="symbol">:rows</span> <span class="number">20</span> <span class="symbol">:cols</span> <span class="number">50</span>&#125; <span class="string">"content"</span>) [<span class="symbol">:br</span>]</div><div class="line">             (<span class="name">submit-button</span> <span class="string">"提交"</span>))))</div></pre></td></tr></table></figure>
<p><code>defpage</code>和<code>common/layout</code>我们之前已经见到过，前者定义了URL<code>/blog/add</code>指向的页面，后者则是套用了一个模板。<code>[:h1 ...]</code>和<code>[:br]</code>也应该熟悉，它们是Hiccup的语法，分别生成<code>&lt;h1&gt;...&lt;/h1&gt;</code>和<code>&lt;br&gt;</code>标签。</p>
<a id="more"></a>
<p><code>form-to</code>是一个新的语法，不过从名字上也可以猜到，它用来生成一个<code>&lt;form&gt;</code>标签，结合<code>[:post &quot;/blog/add&quot;]</code>一起来看就是<code>&lt;form action=&quot;/blog/add&quot; method=&quot;post&quot;&gt;...&lt;/form&gt;</code>。至于<code>label</code>、<code>text-field</code>、<code>text-area</code>、以及<code>submit-button</code>都是用来生成相应的表单标签的，它们包含在hiccup.form-helpers命名空间中，具体用法可以到REPL中查看它们的文档，如：（在项目目录中执行<code>lein repl</code>）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">blog.server=&gt; (use 'hiccup.form-helpers)</div><div class="line">nil</div><div class="line">blog.server=&gt; (doc label)</div><div class="line">-------------------------</div><div class="line">hiccup.form-helpers/label</div><div class="line">([name text]) ; 这个函数接受两个参数，第一个参数是for属性，第二个是它的文本，即&lt;label for="name"&gt;text&lt;/label&gt;。</div><div class="line">  Creates a label for an input field with the supplied name.</div><div class="line">nil</div><div class="line">blog.server=&gt; (doc text-field)</div><div class="line">-------------------------</div><div class="line">hiccup.form-helpers/text-field</div><div class="line">([name] [name value]) ; 这个函数可以传一个或两个参数，第一个参数是name属性，第二个参数是value，即&lt;input type="text" name="name" value="value"&gt;。</div><div class="line">  Creates a new text input field.</div><div class="line">nil</div></pre></td></tr></table></figure>
<p><code>{:size 50}</code>是个很特别的地方，虽然从字面上就能猜出它是<code>&lt;input&gt;</code>标签的<code>size</code>属性，用来设置文本框的长度的，但为什么会是这样的语法呢？这是Clojure定义的吗？当然不是。还记得我们之前提过的宏吗？开发者可以用宏来定义新的语法，Hiccup就定义了这样的语法，可以用map的形式传入额外的HTML属性。尝试在REPL中执行<code>(html [:font {:color &quot;red&quot;} &quot;hi&quot;])</code>，看看结果是什么吧。</p>
<h3 id="接收表单信息"><a href="#接收表单信息" class="headerlink" title="接收表单信息"></a>接收表单信息</h3><p>接下来我们再创建一个页面来接收表单信息。Noir可以按照HTTP方式的不同（GET、POST、DELETE等）来进行路由，比如同样是<code>/blog/add</code>这个URL，我们可以为它创建一个独立的页面，响应POST请求：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">defpage</span> [<span class="symbol">:post</span> <span class="string">"/blog/add"</span>] []</div><div class="line">  <span class="string">"添加成功"</span>)</div></pre></td></tr></table></figure>
<p>尝试提交刚才的页面，会发现得到了预期结果：添加成功。那如何接收表单信息呢？</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">defpage</span> [<span class="symbol">:post</span> <span class="string">"/blog/add"</span>] &#123;<span class="symbol">:as</span> forms&#125;</div><div class="line">  (<span class="name"><span class="builtin-name">str</span></span> <span class="string">"添加成功，文章标题是："</span> (<span class="symbol">:title</span> forms)))</div></pre></td></tr></table></figure>
<p>似乎又多了几个新奇的语法，我们一一来解释：</p>
<p><code>{:as forms}</code>是一种解构（destructuring）语法，解构的对象是list或map，将它们包含的元素拆解出来。Noir在调用页面函数时（defpage实质上是创建了一个函数）会将接收到的参数以map的形式传递给该函数，如<code>title=greeting&amp;content=helloworld</code>会以`{:title “greeting”, :content “helloworld”}的形式传递过来，函数可以通过以下几种方式对map类型进行解构：</p>
<ul>
<li>不接收参数，使用<code>[]</code>来表示。</li>
<li>接收指定名称的参数，如<code>{title :title, content :content}</code>，它会将map中键名为:title的值赋给title变量，:content的内容赋给content变量，其他的键名会丢弃。如果键名很多，可以用这种缩写形式：<code>{:keys [title content]}</code>。</li>
<li>接收整个map，使用<code>{:as forms}</code>，其中forms是自定义的，这样就能从forms变量中获取某个键的值。</li>
<li>将以上两者结合，即<code>{title :title, content :content, :as forms}</code>，需要注意的是forms中还是包含:title和:content的，不会因为它们已经被赋值给其他变量了而从map中剔除掉。</li>
</ul>
<p>你可以将上面这段代码中的<code>{:as forms}</code>替换成其他形式来进行实验，看看是否真的掌握了解构的用法。至于对list对象的解构，我们以后会遇到。</p>
<p>如何获取map中某个键的值？之前我们在与Java交互时提过有两种方法：<code>(get forms :title)</code>和<code>(.get forms :title)</code>，这里展示的是第三种：<code>(:title forms)</code>，即用关键字作为一个函数，获取map中的值。如果键不存在则返回nil，可以提供默认值：<code>(:title forms &quot;Default Title&quot;)</code>。</p>
<p><code>str</code>则是一个函数，会将它所接收到的所有参数转换成字符串并拼接起来（中间不会添加空格）。</p>
<h3 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h3><p>“永远不要相信用户输入的信息”，我们必须对表单内容进行验证，比如标题为空时我们应该显示错误信息，并让用户重新填写。Noir提供了表单验证的相关函数，位于noir.validation命名空间下。下面我们就来添加简单的验证功能：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">(<span class="name"><span class="builtin-name">ns</span></span> ...</div><div class="line">  (<span class="symbol">:require</span> [noir.validation <span class="symbol">:as</span> vali]))</div><div class="line"></div><div class="line">(<span class="name"><span class="builtin-name">defn</span></span> valid? [&#123;<span class="symbol">:keys</span> [title content]&#125;]</div><div class="line">  (<span class="name">vali/rule</span> (<span class="name">vali/has-value?</span> title)</div><div class="line">             [<span class="symbol">:title</span> <span class="string">"标题不能为空。"</span>])</div><div class="line">  (<span class="name">vali/rule</span> (<span class="name">vali/min-length?</span> title <span class="number">10</span>)</div><div class="line">             [<span class="symbol">:title</span> <span class="string">"标题不能少于10个字符。"</span>])</div><div class="line">  (<span class="name">vali/rule</span> (<span class="name">vali/has-value?</span> content)</div><div class="line">             [<span class="symbol">:content</span> <span class="string">"内容不能为空。"</span>])</div><div class="line">  (<span class="name"><span class="builtin-name">not</span></span> (<span class="name">vali/errors?</span> <span class="symbol">:title</span> <span class="symbol">:content</span>)))</div><div class="line"></div><div class="line">(<span class="name">defpage</span> [<span class="symbol">:post</span> <span class="string">"/blog/add"</span>] &#123;<span class="symbol">:as</span> forms&#125;</div><div class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">valid?</span> forms)</div><div class="line">    (<span class="name"><span class="builtin-name">str</span></span> <span class="string">"添加成功，文章标题是："</span> (<span class="symbol">:title</span> forms))</div><div class="line">    (<span class="name"><span class="builtin-name">str</span></span> (<span class="name">vali/get-errors</span> <span class="symbol">:title</span>) (<span class="name">vali/get-errors</span> <span class="symbol">:content</span>))))</div></pre></td></tr></table></figure>
<p>这段代码的运行效果是：如果提交的表单中标题和内容都有值，则显示“添加成功”，否则提示“标题不为空”、“内容不为空”等。我们来分析一下这段代码。</p>
<p><code>defn</code>定义一个函数，它的参数使用了前面提到的解构，函数体则是由三条语句构成。<code>valid?</code>是合法的函数名吗？前面提过Clojure的变量可以包含特殊字符，所以函数名中是可以存在<code>?</code>、<code>!</code>等字符的。当然我们也有一些习惯，比如以<code>?</code>结尾的函数名一般会返回布尔型。</p>
<p><code>vali/rule</code>函数用来描述一个验证规则，它的第一个参数是一个能够返回布尔型的表达式，第二个参数是一个向量（vector），包含两个元素，分别是字段名和错误提示信息，用于生成一个包含所有错误信息的map。以上面这段代码为例，如果三条验证都不通过，那生成的错误信息会是<code>{:title [&quot;标题不能为空。&quot; &quot;标题不能少于10个字符。&quot;], :content [&quot;内容不能为空。&quot;]}</code>。不过，这个map是由<code>noir.validation</code>维护的，我们不能直接获取到。</p>
<p><code>vali/errors?</code>接收一个字段列表，如果有一个字段验证不通过（产生了错误信息）则返回真，<code>not</code>函数自然就是将这个“真”转换为“假”，从而和<code>valid?</code>的语义一致，即不合法（验证不通过）。</p>
<p>最后，<code>vali/get-errors</code>函数可以将验证过程中生成的错误信息按照字段名提取出来。</p>
<p>这里我们还第一次遇到了流程控制语句：<code>if</code>，它和<code>let</code>一样是一种“特殊形式(Special Form)”。它的一般格式是<code>(if 布尔型 语句1 语句2)</code>，如<code>(if (&gt; 1 2) (println true) (println false))</code>。如果语句包含多行怎么办？可以使用<code>do</code>函数。如果条件分支只有一个，则可以使用<code>when</code>和<code>when-not</code>，这时可以直接包含多行语句，不需要使用<code>do</code>。以下是一些示例：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> <span class="number">1</span> <span class="number">2</span>)</div><div class="line">  (<span class="name"><span class="builtin-name">do</span></span></div><div class="line">    (<span class="name">println</span> <span class="number">1</span>)</div><div class="line">    (<span class="name">println</span> <span class="number">2</span>))</div><div class="line">  (<span class="name">println</span> <span class="number">3</span>)) <span class="comment">;-&gt; 3</span></div><div class="line"></div><div class="line">(<span class="name"><span class="builtin-name">when</span></span> (<span class="name"><span class="builtin-name">&lt;</span></span> <span class="number">1</span> <span class="number">2</span>)</div><div class="line">  (<span class="name">println</span> <span class="number">1</span>)</div><div class="line">  (<span class="name">println</span> <span class="number">2</span>)) <span class="comment">;-&gt; 1 \n 2</span></div></pre></td></tr></table></figure>
<h3 id="错误提示"><a href="#错误提示" class="headerlink" title="错误提示"></a>错误提示</h3><p>那如何实现这样的需求：如果表单验证不通过，则重新显示表单，加入用户之前提交的内容，并显示出错信息。要做到这一点，就需要使用两个新的函数，<code>vali/on-error</code>和<code>noir.core/render</code>，并对<code>/blog/add</code>页面做一些修改。</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">(<span class="name">defpartial</span> error-item [[first-error]]</div><div class="line">  [<span class="symbol">:span.error</span> first-error])</div><div class="line"></div><div class="line">(<span class="name">defpage</span> <span class="string">"/blog/add"</span> &#123;<span class="symbol">:as</span> forms&#125;</div><div class="line">  (<span class="name">common/layout</span></div><div class="line">    [<span class="symbol">:h1</span> <span class="string">"新建文章"</span>]</div><div class="line">    (<span class="name">form-to</span> [<span class="symbol">:post</span> <span class="string">"/blog/add"</span>]</div><div class="line">             (<span class="name">label</span> <span class="string">"title"</span> <span class="string">"标题："</span>)</div><div class="line">             (<span class="name">text-field</span> &#123;<span class="symbol">:size</span> <span class="number">50</span>&#125; <span class="string">"title"</span> (<span class="symbol">:title</span> forms))</div><div class="line">             (<span class="name">vali/on-error</span> <span class="symbol">:title</span> error-item) [<span class="symbol">:br</span>]</div><div class="line">             (<span class="name">label</span> <span class="string">"content"</span> <span class="string">"内容："</span>)</div><div class="line">             (<span class="name">text-area</span> &#123;<span class="symbol">:rows</span> <span class="number">20</span> <span class="symbol">:cols</span> <span class="number">50</span>&#125; <span class="string">"content"</span> (<span class="symbol">:content</span> forms))</div><div class="line">             (<span class="name">vali/on-error</span> <span class="symbol">:content</span> error-item) [<span class="symbol">:br</span>]</div><div class="line">             (<span class="name">submit-button</span> <span class="string">"提交"</span>))))</div><div class="line"></div><div class="line"><span class="comment">; 此处省略valid?函数，它没有变化</span></div><div class="line"></div><div class="line">(<span class="name">defpage</span> [<span class="symbol">:post</span> <span class="string">"/blog/add"</span>] &#123;<span class="symbol">:as</span> forms&#125;</div><div class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">valid?</span> forms)</div><div class="line">    (<span class="name"><span class="builtin-name">str</span></span> <span class="string">"添加成功，文章标题是："</span> (<span class="symbol">:title</span> forms))</div><div class="line">    (<span class="name">render</span> <span class="string">"/blog/add"</span> forms)))</div></pre></td></tr></table></figure>
<p>先看<code>render</code>，它是Noir提供的一个函数，能够在页面中渲染另一个页面的内容，就像调用一个函数一样。这里我们则是在表单提交的页面里渲染了“新建文章”页面的内容，并将表单参数传递了过去。</p>
<p>对“新建文章”页面我们做了以下修改：</p>
<ul>
<li>接收参数，并作为<code>forms</code>变量保存这个map。</li>
<li>为<code>text-field</code>和<code>text-area</code>两个表单控件添加了默认值。</li>
<li>调用了<code>vali/on-error</code>函数，当某个字段包含错误信息时，它会调用第二个参数所指向的函数（这里是<code>error-item</code>），并将该字段的错误信息作为参数传递给这个函数。</li>
</ul>
<p><code>error-item</code>函数的功能很简单，将接受到的错误信息渲染成一个<code>&lt;span&gt;</code>标签展示出来。这里的<code>[:span.error ...]</code>会被解析成<code>&lt;span class=&quot;error&quot;&gt;...&lt;/span&gt;</code>。至于<code>[[first-error]]</code>，它是一种对list对象的解构操作。前面我们看到在错误信息中，某个字段即使只有一条错误信息，也会以向量的形式保存。我们这里只需要每个字段的第一条错误信息，所以使用了这种形式。你可以这样重写<code>error-item</code>，效果是一样的：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">defpartial</span> error-item [errors]</div><div class="line">  [<span class="symbol">:span.error</span> (<span class="name"><span class="builtin-name">first</span></span> errors)])</div></pre></td></tr></table></figure>
<h2 id="操作数据库"><a href="#操作数据库" class="headerlink" title="操作数据库"></a>操作数据库</h2><p>Clojure程序连接数据库可以使用<code>clojure.java.jdbc</code>这个类库，它能够操作MySQL、PostgreSQL、SQLite、MSSQL等。这里我们将演示如何连接MySQL数据库，因此除了<code>clojure.java.jdbc</code>外，还需要添加MySQL Connector依赖项：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">defproject</span> ...</div><div class="line">            <span class="symbol">:dependencies</span> [...</div><div class="line">                           [org.clojure/java.jdbc <span class="string">"0.2.3"</span>]</div><div class="line">                           [mysql/mysql-connector-java <span class="string">"5.1.6"</span>]]</div><div class="line">            ...)</div></pre></td></tr></table></figure>
<p>为了保存博客文章，我们在本地MySQL服务中新建一个<code>blog_db</code>数据库，并赋予用户<code>blog_db</code>（密码相同）该库的所有权限。然后我们会建立一张article表，用于保存文章：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ mysql -uroot -p</div><div class="line">mysql&gt; create database blog_db collate utf8_general_ci;</div><div class="line">mysql&gt; grant all on blog_db.* to &apos;blog_db&apos;@&apos;localhost&apos; identified by &apos;blog_db&apos;;</div><div class="line">mysql&gt; CREATE TABLE `article` (</div><div class="line">    -&gt;   `id` int(11) NOT NULL AUTO_INCREMENT,</div><div class="line">    -&gt;   `title` varchar(500) NOT NULL,</div><div class="line">    -&gt;   `content` text NOT NULL,</div><div class="line">    -&gt;   `user_id` int(11) NOT NULL,</div><div class="line">    -&gt;   `created` datetime NOT NULL,</div><div class="line">    -&gt;   PRIMARY KEY (`id`)</div><div class="line">    -&gt; ) ENGINE=InnoDB;</div></pre></td></tr></table></figure>
<p>我们新建一个<code>src/blog/database.clj</code>文件，用来存放数据库连接信息：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(<span class="name"><span class="builtin-name">ns</span></span> blog.database)</div><div class="line"></div><div class="line">(<span class="name"><span class="builtin-name">def</span></span> db-spec &#123;<span class="symbol">:classname</span> <span class="string">"com.mysql.jdbc.Driver"</span></div><div class="line">              <span class="symbol">:subprotocol</span> <span class="string">"mysql"</span></div><div class="line">              <span class="symbol">:subname</span> <span class="string">"//127.0.0.1:3306/blog_db?useUnicode=true&amp;characterEncoding=UTF-8"</span></div><div class="line">              <span class="symbol">:user</span> <span class="string">"blog_db"</span></div><div class="line">              <span class="symbol">:password</span> <span class="string">"blog_db"</span>&#125;)</div></pre></td></tr></table></figure>
<p>接着新建<code>src/blog/models/blog.clj</code>文件，编写插入记录的函数：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(<span class="name"><span class="builtin-name">ns</span></span> blog.models.blog</div><div class="line">  (<span class="symbol">:require</span> [clojure.java.jdbc <span class="symbol">:as</span> sql])</div><div class="line">  (<span class="symbol">:use</span> [blog.database <span class="symbol">:only</span> [db-spec]])</div><div class="line">  (<span class="symbol">:import</span> java.sql.Timestamp))</div><div class="line"></div><div class="line">(<span class="name"><span class="builtin-name">defn</span></span> add! [forms]</div><div class="line">  (<span class="name">sql/with-connection</span> db-spec</div><div class="line">    (<span class="name">sql/insert-records</span> <span class="string">"article"</span></div><div class="line">      &#123;<span class="symbol">:title</span> (<span class="symbol">:title</span> forms)</div><div class="line">       <span class="symbol">:content</span> (<span class="symbol">:content</span> forms)</div><div class="line">       <span class="symbol">:user_id</span> <span class="number">0</span></div><div class="line">       <span class="symbol">:created</span> (<span class="name">Timestamp.</span> (<span class="name">System/currentTimeMillis</span>))&#125;)))</div></pre></td></tr></table></figure>
<p>最后，我们只需要在<code>src/blog/views/article.clj</code>中调用这个函数即可：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(<span class="name"><span class="builtin-name">ns</span></span> ...</div><div class="line">  (<span class="symbol">:require</span> ...</div><div class="line">            [blog.models.blog <span class="symbol">:as</span> model-blog]))</div><div class="line"></div><div class="line">(<span class="name">defpage</span> [<span class="symbol">:post</span> <span class="string">"/blog/add"</span>] &#123;<span class="symbol">:as</span> forms&#125;</div><div class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">valid?</span> forms)</div><div class="line">    (<span class="name"><span class="builtin-name">str</span></span> <span class="string">"添加成功，文章编号是："</span></div><div class="line">         (<span class="symbol">:generated_key</span> (<span class="name"><span class="builtin-name">first</span></span> (<span class="name">model-blog/add!</span> forms))))</div><div class="line">    (<span class="name">render</span> <span class="string">"/blog/add"</span> forms)))</div></pre></td></tr></table></figure>
<p>这里我们见到了<code>clojure.java.jdbc</code>命名空间下的两个函数：<code>with-connection</code>和<code>insert-records</code>。前者用来打开一个数据库连接，它的第一个参数可以是一个map，表示数据库的连接信息，也可以是字符串，还可以直接传递一个DataSource对象，这点我们会在如何使用连接池时讲解。当<code>with-connection</code>执行完毕时，数据库连接也会随之关闭。<code>insert-record</code>则用于插入一条或多条数据，第一个参数是数据表名，第二个参数开始则是将要插入的记录。这个函数的返回值你应该可以从<code>(:generated_key ...)</code>这段代码中猜出来。</p>
<p>注意，我们的数据表中有一个DATETIME类型的字段，它需要使用<code>java.sql.Timestamp</code>类型来赋值。Clojure中引入一个类可以使用<code>import</code>函数，<code>ns</code>宏提供了便捷的方式<code>:import</code>。当需要一次导入多个类时，可以使用<code>(:import (java.sql Timestamp Date Time))</code>。</p>
<h3 id="使用C3P0连接池"><a href="#使用C3P0连接池" class="headerlink" title="使用C3P0连接池"></a>使用C3P0连接池</h3><p>在高性能网站中，频繁开关数据库连接不是个好主意，通常的方式是使用连接池。这里我们演示如何使用C3P0连接池。</p>
<ul>
<li>添加依赖项：<code>[c3p0 &quot;0.9.1.2&quot;]</code></li>
<li>修改<code>src/blog/database.clj</code>，添加以下代码：</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(<span class="name"><span class="builtin-name">ns</span></span> blog.database</div><div class="line">  (<span class="symbol">:import</span> com.mchange.v2.c3p0.ComboPooledDataSource))</div><div class="line"></div><div class="line">(<span class="name"><span class="builtin-name">def</span></span> db-spec ...) <span class="comment">; db-spec没有变化，此处省略</span></div><div class="line"></div><div class="line">(<span class="name"><span class="builtin-name">def</span></span> pool</div><div class="line">  (<span class="name"><span class="builtin-name">let</span></span> [cpds (<span class="name"><span class="builtin-name">doto</span></span> (<span class="name">ComboPooledDataSource.</span>)</div><div class="line">               (<span class="name">.setDriverClass</span> (<span class="symbol">:classname</span> db-spec))</div><div class="line">               (<span class="name">.setJdbcUrl</span> (<span class="name"><span class="builtin-name">str</span></span> <span class="string">"jdbc:"</span> (<span class="symbol">:subprotocol</span> spec) <span class="string">":"</span> (<span class="symbol">:subname</span> db-spec)))</div><div class="line">               (<span class="name">.setUser</span> (<span class="symbol">:user</span> db-spec))</div><div class="line">               (<span class="name">.setPassword</span> (<span class="symbol">:password</span> db-spec)))]</div><div class="line">    &#123;<span class="symbol">:datasource</span> cpds&#125;))</div></pre></td></tr></table></figure>
<ul>
<li>更换<code>src/blog/models/blog.clj</code>中<code>with-connection</code>的参数：</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(<span class="name"><span class="builtin-name">ns</span></span> ...</div><div class="line">  (<span class="symbol">:use</span> [blog.database <span class="symbol">:only</span> [pool]]))</div><div class="line"></div><div class="line">(<span class="name"><span class="builtin-name">defn</span></span> add! [forms]</div><div class="line">  (<span class="name">sql/with-connection</span> pool</div><div class="line">    ...))</div></pre></td></tr></table></figure>
<p><code>with-connection</code>接收到的参数形式是<code>{:datasource DataSource接口的实例}</code>，<code>(ComboPooledDataSource.)</code>就是这样的一个实例，这种语法和<code>(new ComboPooledDataSource)</code>等价。<code>doto</code>函数表示连续调用第一个参数所指向的对象的方法，最后返回这个对象。这段代码可以有不同的写法，如<code>(def pool {:datasource (doto (Combo...))})</code>。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这一章我们学习了如何配置Eclipse以编写Leiningen项目；如何使用表单和接受参数，特别是表单验证和错误信息的提示；最后我们演示了如何将数据保存到MySQL中，并使用连接池来优化项目。下一节我们将为博客增加用户登录的功能，以讲解Cookie和Session的使用。我们还会学习如何对Leiningen项目进行打包和发布，并尝试将我们的博客发布到PaaS平台Heroku上去。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://shzhangji.com/blog/2012/12/08/cia-noir-2/" data-id="ciyir4uzd000bvem6hlrf0fsg" class="article-share-link">Share</a>
      
        <a href="http://shzhangji.com/blog/2012/12/08/cia-noir-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/clojure/">clojure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/noir/">noir</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2012/12/16/cia-noir-3/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Clojure实战(3)：使用Noir框架开发博客(下)
        
      </div>
    </a>
  
  
    <a href="/blog/2012/11/25/cia-noir-1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Clojure实战(1)：使用Noir框架开发博客(上)</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/aosa/" style="font-size: 12.5px;">aosa</a> <a href="/tags/clojure/" style="font-size: 20px;">clojure</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/english/" style="font-size: 17.5px;">english</a> <a href="/tags/fp/" style="font-size: 10px;">fp</a> <a href="/tags/frontend/" style="font-size: 10px;">frontend</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/hadoop/" style="font-size: 12.5px;">hadoop</a> <a href="/tags/hive/" style="font-size: 10px;">hive</a> <a href="/tags/javascript/" style="font-size: 12.5px;">javascript</a> <a href="/tags/lodash/" style="font-size: 10px;">lodash</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/noir/" style="font-size: 15px;">noir</a> <a href="/tags/ops/" style="font-size: 10px;">ops</a> <a href="/tags/perl/" style="font-size: 12.5px;">perl</a> <a href="/tags/programming/" style="font-size: 10px;">programming</a> <a href="/tags/python/" style="font-size: 12.5px;">python</a> <a href="/tags/scala/" style="font-size: 10px;">scala</a> <a href="/tags/scalatra/" style="font-size: 10px;">scalatra</a> <a href="/tags/spark/" style="font-size: 12.5px;">spark</a> <a href="/tags/storm/" style="font-size: 10px;">storm</a> <a href="/tags/translation/" style="font-size: 10px;">translation</a> <a href="/tags/webjars/" style="font-size: 10px;">webjars</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2017/01/29/difference-between-lodash-assign-and-assignin/">Difference Between Lodash _.assign and _.assignIn</a>
          </li>
        
          <li>
            <a href="/blog/2017/01/08/python-2-to-3-quick-guide/">Python 2 to 3 Quick Guide</a>
          </li>
        
          <li>
            <a href="/blog/2016/03/13/top-5-frameworks/">开发人员必知的5种开源框架</a>
          </li>
        
          <li>
            <a href="/blog/2015/09/12/model-dependency-injection-with-spring-aop/">使用Spring AOP向领域模型注入依赖</a>
          </li>
        
          <li>
            <a href="/blog/2015/09/05/anemic-domain-model/">贫血领域模型</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Ji ZHANG<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/categories/Big-Data" class="mobile-nav-link">Big Data</a>
  
    <a href="/categories/Programming" class="mobile-nav-link">Programming</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'jizhang';
  
  var disqus_url = 'http://shzhangji.com/blog/2012/12/08/cia-noir-2/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="https://ajax.proxy.ustclug.org/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>